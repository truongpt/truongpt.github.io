## bzip2 vs x265

Tá»« khi biáº¿t Ä‘áº¿n máº¥y chuáº©n nÃ©n video gáº§n Ä‘Ã¢y (nÃ³i lÃ  gáº§n Ä‘Ã¢y nhÆ°ng tháº­t ra tá»« H.264 Ä‘áº¿n giá» cÅ©ng 14 nÄƒm cÃ³ láº» rá»“i) nhÆ° H.264, H.265 Ä‘á»u há»— trá»£ nÃ©n khÃ´ng máº¥t dá»¯ liá»‡u (lossless compression), báº±ng cÃ¡ch bá» quÃ¡ trÃ¬nh transform vÃ  quantization, xem á»Ÿ má»¥c Perceptual redundancy. ÄÃ´i lÃºc tÃ´i tháº¯c máº¯c xem thá»­ so sÃ¡nh sÃ¡nh nÃ³ vá»›i máº¥y cÃ¡i tool nÃ©n thÆ°á»ng dÃ¹ng nÃ©n cÃ¡c dá»¯ liá»‡u nÃ³i chung nhÆ° Zip, Rar xem xem tá»‰ lá»‡ nÃ©n nÃ³ cá»¡ bao nhiÃªu.

Kiá»ƒm tra bÃªn nÃ o nÃ©n máº¡nh hÆ¡n lÃ  má»™t viá»‡c lÃ m khÃ¡ lÃ  phi khoa há»c, vÃ¬ má»¥c Ä‘Ã­ch vÃ  Ä‘á»‘i tÆ°á»£ng cá»§a 2 tháº±ng khÃ¡c háº³n nhau, nÃªn viá»‡c so sÃ¡nh kiá»ƒu nÃ y ráº¥t kháº­p khiá»…ng, khÃ´ng cÃ³ Ã½ nghÄ©a gÃ¬ nhiá»u, cÅ©ng cháº£ nÃ³i Ä‘Æ°á»£c lÃªn Ä‘iá»u chi ná»‘t. CÆ¡ mÃ  mÃ¬nh thÃ­ch thÃ¬ mÃ¬nh thá»­ thÃ´i, thá»­ qua 1 láº§n Ä‘á»ƒ tá»« giá» vá» sau Ä‘á»¡ â€œbá»©t rá»©tâ€.

TÃ´i chá»n bzip2 Ä‘á»ƒ nÃ©n kiá»ƒu zip, lá»±a chá»n kiá»ƒu zip lÃ  khÃ¡ lÃ  ngáº«u nhiÃªn vÃ¬ tÃ´i khÃ´ng biáº¿t nhiá»u vá» cÃ¡c tool & thuáº­t toÃ¡n nÃ©n nÃ y Ä‘á»ƒ lá»±a chá»n, Ä‘Æ¡n giáº£n zip lÃ  thuáº­t toÃ¡n nÃ©n cÃ³ láº½ Ä‘Æ°á»£c dÃ¹ng nhiá»u nháº¥t, cÃ²n chá»n bzip2 lÃ  do dá»±a vÃ o bÃ i [nÃ y](https://tukaani.org/lzma/benchmarks.html) cho tháº¥y bzip2 nÃ©n cao so vá»›i cÃ¡c pháº§n má»m nÃ©n khÃ¡c nhÆ° gzip, lzmash.

Vá» nÃ©n video, tÃ´i chá»n H.265 vÃ¬ thá»i Ä‘iá»ƒm hiá»‡n táº¡i nÃ³ lÃ  chuáº©n nÃ©n video cho phÃ©p tá»‰ lá»‡ nÃ©n cao nháº¥t. Äá»ƒ nÃ©n video theo chuáº©n H.265 thÃ¬ chá»n [x265](https://github.com/videolan/x265), theo nhá»¯ng gÃ¬ tÃ´i biáº¿t thÃ¬ Ä‘Ã¢y cÃ³ váº» lÃ  open source phá»• biáº¿n vÃ  cung cáº¥p Ä‘á»™ nÃ©n tá»‘t nháº¥t so vá»›i cÃ¡c bá»™ encoder theo chuáº©n H.265. Báº£n thÃ¢n x265 Ä‘Æ°á»£c xÃ¢y dá»±ng dá»±a trÃªn [HM tool](https://hevc.hhi.fraunhofer.de/) (HEVC model), lÃ  cÃ´ng cá»¥ Ä‘Æ°á»£c nhÃ³m [JCT-VC](https://www.itu.int/en/ITU-T/studygroups/2013-2016/16/Pages/video/jctvc.aspx) xÃ¢y dá»±ng trong quÃ¡ trÃ¬nh xÃ¢y dá»±ng Ä‘áº·c táº£ cá»§a H.265/HEVC.

NgoÃ i ra x265 thá»«a káº¿ ráº¥t nhiá»u thuáº­t toÃ¡n nÃ©n tá»« x264 (nhÃ¬n cÃ¡i tÃªn cháº¯c cÅ©ng Ä‘oÃ¡n Ä‘Æ°á»£c). MÃ  x264 lÃ  open source tá»‘t nháº¥t thá»±c hiá»‡n nÃ©n theo chuáº©n H.264, nghe Ä‘Ã¢u facebook, youtube cÅ©ng dÃ¹ng (nhÆ°ng tÃ´i khÃ´ng tÃ¬m tháº¥y thÃ´ng tin tham kháº£o ngoÃ i website chÃ­nh cá»§a x264), do Ä‘Ã³ tÃ´i nghÄ© cháº¯c x265 ngon :-), vÃ  táº¥t nhiÃªn cÃ¡i quan trá»ng nháº¥t Ä‘á»ƒ lá»±a chá»n á»Ÿ Ä‘Ã¢y lÃ  cáº£ nÃ³ há»— trá»£ mode lossless.

Vá»›i bzip2 thÃ¬ file kiá»ƒu gÃ¬ cÅ©ng khÃ´ng thÃ nh váº¥n Ä‘á», nhÆ°ng vá»›i x265 vÃ¬ báº£n cháº¥t nÃ³ nÃ©n video, nÃªn file Ä‘Ã³ pháº£i lÃ  sá»‘ nguyÃªn láº§n cá»§a frame size nÃ o Ä‘Ã³ ğŸ™‚ vÃ­ dá»¥ 1920Ã—1080 hay chÃ­ Ã­t cÅ©ng pháº£i lÃ  16Ã—16, vÃ¬ tháº¿ náº¿u dÃ¹ng file báº¥t kÃ¬ thÃ¬ pháº£i thÃªm 1 Ä‘oáº¡n dummy data vÃ o cho nÃ³ Ä‘áº£m báº£o viá»‡c alignment Ä‘áº¥y, sau nÃ y khi cáº§n giáº£i nÃ©n file Ä‘Ã£ nÃ©n thÃ¬ ta cáº¯t bá» Ä‘oÃ¡n dummy data Ä‘áº¥y ra lÃ  Ä‘Æ°á»£c.
Tuy nhiÃªn Ä‘á»ƒ Ä‘Æ¡n giáº£n thÃ¬ tÃ´i chá»n luÃ´n 1 file raw video, Ä‘Ã¢y cÅ©ng lÃ  táº¡o Ä‘iá»u kiá»‡n thuáº­n lá»£i cho x265, coi nhÆ° bzip2 cá»­a trÃªn, cháº¥p 1 quáº£ trÆ°á»›c.

Äáº§u tiÃªn, ngÆ°á»i nÃ´ng dÃ¢n pháº£i táº¡o file raw video, Ä‘á»ƒ táº¡o raw video ta kiáº¿m 1 file video nÃ o Ä‘Ã³ dáº¡ng .mp4 cháº³ng háº¡n, cÃ¡i nÃ y ráº¥t dá»… vÃ¬ a/e thÆ°á»ng hay phim áº£nh.
```
$ffmpeg -i conchocon.mp4 -vframes 100 -c:v rawvideo -pix_fmt yuv420p out.yuv
```

File Ä‘ang dÃ¹ng cÃ³ Ä‘á»‹nh dáº¡ng yuv420p, 1440Ã—1080 â†’ 1 frame size = 1440x1080x1.5 = 2332800 (byte), váº­y 100 frame thÃ¬ 233280000 byte.

NÃ©n báº±ng bzip2 vá»›i option cho tá»‰ lá»‡ nÃ©n cao nháº¥t.
```
$bzip2 â€“best -z -k out.yuv
```

Káº¿t quáº£ file nÃ©n = 85802555 byte, nhÆ° váº­y tá»‰ lá»‡ nÃ©n lÃ  233280000/85802555 ~ 2.71 láº§n.

Tiáº¿p Ä‘áº¿n nÃ©n lostless báº±ng x265 vá»›i option â€œâ€“preset placeboâ€ tá»©c tá»‘i Æ°u vá» tá»‰ lá»‡ nÃ©n.

```
$x265.exe â€“input out.yuv â€“fps 30 â€“preset placebo â€“lossless â€“input-res 1440Ã—1080 â€“frames 100 -o lossless.h265
```

Káº¿t quáº£ file sau khi nÃ©n cÃ³ kÃ­ch thÆ°á»›c 32171670 byte, Ä‘áº¡t tá»‰ lá»‡ nÃ©n lÃ  233280000/32171670 ~ 7.25. DÃ¹ng option nÃ©n nÃ y thÃ¬ thá»i gian nÃ©n cá»±c kÃ¬ lÃ¢u, chá»‰ vá»›i 100 frame tá»©c lÃ  khoáº£ng 3 giÃ¢y video nhÆ°ng nÃ©n háº¿t hÆ¡n 30 phÃºt vá»›i cáº¥u hÃ¬nh mÃ¡y Intel(R) Core(TM) i5-3470 CPU@3.20GHz 3.20GHz, 8.00GB.

Tuy nhiÃªn ngay cáº£ lÃºc tÃ´i cháº¥p nháº­n khÃ´ng chá»n Æ°u tiÃªn má»©c Ä‘á»™ nÃ©n mÃ  chá»n viá»‡c tá»‘i Æ°u cho tá»‘c Ä‘á»™ â€ â€“preset ultrafastâ€ Ä‘á»ƒ rÃºt ngáº¯n thá»i gian nÃ©n, lÃºc Ä‘áº¥y háº¿t táº§m 16 giÃ¢y, thÃ¬ file sau khi nÃ©n cÅ©ng Ä‘áº¡t Ä‘Æ°á»£c 40435062 byte, tá»‰ lá»‡ nÃ©n lÃ  233280000/40435062 ~ 5.77. Káº¿t quáº£ ngoÃ i dá»± Ä‘oÃ¡n cá»§a tÃ´i.

Äá»ƒ cháº¯c Äƒn lÃ  x265 Ä‘Ã£ thá»±c hiá»‡n nÃ©n lostless, ta cÃ³ thá»ƒ dÃ¹ng ffmpeg giáº£i nÃ©n (decode) vÃ  so sÃ¡nh nÃ³ vá»›i file gá»‘c lÃºc Ä‘áº§u.

```
$ffmpeg -i lossless.h265 dec.yuv
$diff dec.yuv out.yuv
```

Do viá»‡c nÃ©n video pháº£i cÃ¢n Ä‘o Ä‘ong Ä‘áº¿m nhiá»u thá»© Ä‘á»ƒ thá»a mÃ£n Ä‘áº·c trÆ°ng khi nÃ©n video, nhÆ° vá» tá»‘c Ä‘á»™, vá» sá»­ dá»¥ng memory â€¦, nÃªn tÃ´i nghÄ© ráº±ng cho dÃ¹ á»Ÿ top Ä‘áº§u nÃ©n video nhÆ° x265 Ä‘i chÄƒng ná»¯a thÃ¬ khÃ³ Äƒn Ä‘Æ°á»£c bzip2 khi so sÃ¡nh á»Ÿ mode lossless. ThÃ nh ra káº¿t quáº£ nháº­n Ä‘Æ°á»£c lÃ m tÃ´i khÃ¡ báº¥t ngá». CÃ³ váº» nhÆ° viá»‡c lá»±a chá»n file raw video, Ä‘á»“ng thá»i Ã­t cÃ³ sá»± chuyá»ƒn cáº£nh Ä‘Ã£ táº¡o nhiá»u Ä‘iá»ƒm lá»£i tháº¿ cho x265, y há»‡t nhÆ° Ä‘ang Ä‘Ã¡ bÃ³ng sÃ¢n nhÃ  cá»§a x265 cÃ´ng thÃªm viá»‡c trá»ng tÃ i thiÃªn vá»‹ cho nÃ³ ná»‘t. LÃºc Ä‘áº§u chá»‰ Ä‘á»‹nh chÆ¡i nhá»Ÿi Ä‘áº¿n Ä‘Ã¢y, nhÆ°ng cÃ³ váº» quÃ¡ thiá»‡t cho bzip2, Ä‘á»ƒ cÃ´ng báº±ng hÆ¡n chÃºt, lÃºc nÃ o ráº£nh thÃ¬ thá»­ xem vá»›i kiá»ƒu file vÄƒn báº£n, text, doc â€¦ thÃ¬ Ä‘iá»u gÃ¬ xáº©y ra.

CÃ²n ná»¯a â€¦

### Tham kháº£o
- [1] https://hevc.hhi.fraunhofer.de
- [2] https://tukaani.org/lzma/benchmarks.html
- [3] https://www.itu.int/en/ITU-T/studygroups/2013-2016/16/Pages/video/jctvc.aspx
- [4] https://github.com/videolan/x265

<a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" />